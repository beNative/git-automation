<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Git Automation Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      // Must be in the <head> to configure Tailwind before it loads.
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    <style>
      :root {
        --title-bar-height: 2rem; /* h-8 */
        --status-bar-height: 1.75rem; /* Equivalent to h-7 in Tailwind */
      }
    </style>
    <script>
      (function bootstrapBrowserMocks() {
        if (window.electronAPI) {
          return;
        }

        const storageKeys = {
          settings: 'ga-browser-globalSettings',
          repositories: 'ga-browser-repositories',
          categories: 'ga-browser-categories',
          uncategorized: 'ga-browser-uncategorizedOrder',
        };

        const readFromStorage = (key, fallback) => {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (error) {
            console.warn('Failed to read demo data from localStorage', error);
            return fallback;
          }
        };

        const writeToStorage = (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.warn('Failed to persist demo data to localStorage', error);
          }
        };

        const sampleRepositories = [
          {
            id: 'repo-ui-stability',
            name: 'UI Stability Dashboard',
            remoteUrl: 'https://example.com/engineering/ui-stability.git',
            localPath: '/Users/dev/projects/ui-stability',
            status: 'Idle',
            lastUpdated: new Date(Date.now() - 1000 * 60 * 42).toISOString(),
            buildHealth: 'Healthy',
            tasks: [
              { id: 'task-run-tests', name: 'Run Tests', steps: [], variables: [], environmentVariables: [], showOnDashboard: true },
              { id: 'task-build-app', name: 'Build App', steps: [], variables: [], environmentVariables: [], showOnDashboard: true },
            ],
            webLinks: [
              { id: 'docs', name: 'Design System', url: 'https://example.com/design-system' },
            ],
            launchConfigs: [
              { id: 'launch-dev', name: 'Start Dev Server', type: 'command', command: 'npm run dev', showOnDashboard: true },
              { id: 'launch-storybook', name: 'Storybook', type: 'command', command: 'npm run storybook', showOnDashboard: false },
            ],
            vcs: 'git',
            branch: 'main',
          },
          {
            id: 'repo-automation-service',
            name: 'Automation Service',
            remoteUrl: 'https://example.com/platform/automation.git',
            localPath: '/Users/dev/projects/automation-service',
            status: 'Success',
            lastUpdated: new Date(Date.now() - 1000 * 60 * 5).toISOString(),
            buildHealth: 'Healthy',
            tasks: [
              { id: 'task-deploy', name: 'Deploy', steps: [], variables: [], environmentVariables: [], showOnDashboard: true },
            ],
            webLinks: [
              { id: 'status', name: 'Status Page', url: 'https://status.example.com' },
            ],
            launchConfigs: [
              { id: 'launch-api', name: 'Run API', type: 'command', command: 'npm run start', showOnDashboard: true },
            ],
            vcs: 'git',
            branch: 'develop',
          },
        ];

        const sampleCategories = [
          {
            id: 'category-frontend',
            name: 'Frontend',
            repositoryIds: ['repo-ui-stability'],
            backgroundColor: 'rgba(59, 130, 246, 0.08)',
            darkBackgroundColor: 'rgba(59, 130, 246, 0.18)',
          },
        ];

        const defaultData = {
          globalSettings: null,
          repositories: sampleRepositories,
          categories: sampleCategories,
          uncategorizedOrder: ['repo-automation-service'],
        };

        const ensureSeedData = () => {
          const repositories = readFromStorage(storageKeys.repositories, null);
          if (!repositories) {
            writeToStorage(storageKeys.repositories, defaultData.repositories);
            writeToStorage(storageKeys.categories, defaultData.categories);
            writeToStorage(storageKeys.uncategorized, defaultData.uncategorizedOrder);
          }
          if (!readFromStorage(storageKeys.settings, null)) {
            writeToStorage(storageKeys.settings, defaultData.globalSettings);
          }
        };

        ensureSeedData();

        const repoIdByPath = new Map(sampleRepositories.map(repo => [repo.localPath, repo.id]));
        const refreshIndexByRepo = new Map(sampleRepositories.map(repo => [repo.id, 0]));

        const detailedStatusSamples = [
          {
            files: { added: 0, modified: 3, deleted: 0, conflicted: 0, untracked: 1, renamed: 0 },
            isDirty: true,
            branchInfo: { ahead: 0, behind: 2, tracking: 'origin/main' },
            updatesAvailable: false,
          },
          {
            files: { added: 1, modified: 1, deleted: 0, conflicted: 0, untracked: 0, renamed: 0 },
            isDirty: true,
            branchInfo: { ahead: 1, behind: 0, tracking: 'origin/main' },
            updatesAvailable: false,
          },
        ];

        const branchSamples = [
          {
            current: 'main',
            local: ['main', 'feature/stable-refresh', 'release/1.2.0'],
            remote: ['origin/main', 'origin/feature/stable-refresh', 'origin/release/1.2.0'],
          },
          {
            current: 'feature/stable-refresh',
            local: ['main', 'feature/stable-refresh', 'release/1.2.0'],
            remote: ['origin/main', 'origin/feature/stable-refresh', 'origin/release/1.2.0'],
          },
        ];

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        window.electronAPI = {
          async getAllData() {
            return {
              globalSettings: readFromStorage(storageKeys.settings, defaultData.globalSettings),
              repositories: readFromStorage(storageKeys.repositories, defaultData.repositories),
              categories: readFromStorage(storageKeys.categories, defaultData.categories),
              uncategorizedOrder: readFromStorage(storageKeys.uncategorized, defaultData.uncategorizedOrder),
            };
          },
          async saveAllData(payload) {
            writeToStorage(storageKeys.settings, payload.globalSettings);
            writeToStorage(storageKeys.repositories, payload.repositories);
            writeToStorage(storageKeys.categories, payload.categories);
            writeToStorage(storageKeys.uncategorized, payload.uncategorizedOrder);
          },
          async checkLocalPath() {
            await delay(150);
            return 'valid';
          },
          async getProjectInfo(repoPath) {
            await delay(200);
            const repoId = repoIdByPath.get(repoPath);
            const nodeCapabilities = {
              engine: 'node@20.10.0',
              declaredManager: 'npm',
              packageManagers: { pnpm: true, yarn: false, npm: true, bun: false },
              typescript: true,
              testFrameworks: ['vitest'],
              linters: ['eslint', 'prettier'],
              bundlers: ['vite'],
              monorepo: { workspaces: false, turbo: false, nx: false, yarnBerryPnp: false },
            };

            if (repoId === 'repo-ui-stability') {
              return {
                tags: ['node', 'react', 'frontend'],
                files: { dproj: [], pomXml: [], csproj: [], sln: [] },
                nodejs: nodeCapabilities,
              };
            }

            return {
              tags: ['node', 'service'],
              files: { dproj: [], pomXml: [], csproj: [], sln: [] },
              nodejs: {
                ...nodeCapabilities,
                testFrameworks: ['jest'],
              },
              docker: {
                composeFiles: ['docker-compose.yml'],
                dockerfiles: ['Dockerfile'],
              },
            };
          },
          async getProjectSuggestions({ repoPath }) {
            await delay(120);
            const repoId = repoIdByPath.get(repoPath);
            if (repoId === 'repo-ui-stability') {
              return [
                { label: 'Run lint', value: 'npm run lint', group: 'npm scripts' },
                { label: 'Launch Storybook', value: 'npm run storybook', group: 'npm scripts' },
              ];
            }
            return [
              { label: 'Run integration tests', value: 'npm run test:integration', group: 'npm scripts' },
              { label: 'Start API locally', value: 'npm run dev', group: 'npm scripts' },
            ];
          },
          async getDelphiVersions() {
            await delay(50);
            return [];
          },
          async getDetailedVcsStatus(repo) {
            await delay(350);
            const nextIndex = refreshIndexByRepo.get(repo.id) === 1 ? 0 : 1;
            refreshIndexByRepo.set(repo.id, nextIndex);
            return detailedStatusSamples[nextIndex];
          },
          async listBranches({ repoPath }) {
            await delay(250);
            const repoId = repoIdByPath.get(repoPath);
            const index = repoId ? refreshIndexByRepo.get(repoId) ?? 0 : 0;
            return branchSamples[index];
          },
          async pruneRemoteBranches() {
            await delay(150);
            console.info('Simulated pruning stale remote branches');
            return { success: true, message: 'Simulated prune completed.' };
          },
          async cleanupLocalBranches() {
            await delay(150);
            console.info('Simulated cleanup of merged or stale local branches');
            return { success: true, message: 'Simulated cleanup completed.' };
          },
          async getGithubPat() {
            await delay(100);
            return '';
          },
          async getAllReleases() {
            await delay(200);
            return [
              {
                id: 1,
                tagName: 'v1.1.0',
                name: 'Stability Improvements',
                body: 'Improved caching and added new dashboards.',
                isDraft: false,
                isPrerelease: false,
                url: 'https://example.com/releases/v1.1.0',
                createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 14).toISOString(),
              },
            ];
          },
          async updateRelease() {
            await delay(150);
            return { success: true };
          },
          async createRelease() {
            await delay(150);
            return { success: true };
          },
          async deleteRelease() {
            await delay(150);
            return { success: true };
          },
          async discoverRemoteUrl({ localPath }) {
            await delay(120);
            const repoId = repoIdByPath.get(localPath);
            const repo = sampleRepositories.find(r => r.id === repoId);
            return { url: repo?.remoteUrl ?? null };
          },
          async showDirectoryPicker() {
            await delay(80);
            return { canceled: false, filePaths: ['/Users/dev/projects'] };
          },
          async getLatestRelease() {
            await delay(200);
            return {
              id: 1,
              tagName: 'v1.2.0',
              name: 'Stable Refresh',
              body: null,
              isDraft: false,
              isPrerelease: false,
              url: 'https://example.com/releases/v1.2.0',
              createdAt: new Date(Date.now() - 1000 * 60 * 60 * 24).toISOString(),
            };
          },
          async openWeblink(url) {
            window.open(url, '_blank', 'noopener');
          },
          async openInstallationFolder() {
            console.info('Requested to open installation folder');
          },
          async openLocalPath(path) {
            console.info('Requested to open local path:', path);
          },
          async openTerminal(path) {
            console.info('Requested to open terminal at:', path);
          },
          async runTaskStep() {
            console.info('Simulated task step execution');
          },
          onWindowMaximizedStatus() {},
          removeWindowMaximizedStatusListener() {},
          windowMinimize() {},
          windowMaximize() {},
          windowClose() {},
          onTaskLog() {},
          removeTaskLogListener() {},
          onTaskStepEnd() {},
          removeTaskStepEndListener() {},
          cancelTaskExecution() {},
          cloneRepository() {},
          launchApplication() {},
          launchExecutable() {},
          checkVcsStatus: async () => ({ status: 'clean' }),
          detectExecutables: async () => ['npm', 'pnpm'],
          onUpdateStatusChange() {},
          removeUpdateStatusChangeListener() {},
          getAppVersion: async () => 'browser-demo',
          onLogFromMain() {},
          removeLogFromMainListener() {},
        };
      })();
    </script>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "electron": "https://aistudiocdn.com/electron@^37.4.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "os": "https://aistudiocdn.com/os@^0.1.2",
    "electron-updater": "https://aistudiocdn.com/electron-updater@^6.6.2",
    "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0",
    "remark-gfm": "https://aistudiocdn.com/remark-gfm@^4.0.1",
    "fs/": "https://aistudiocdn.com/fs@^0.0.1-security/",
    "child_process": "https://aistudiocdn.com/child_process@^1.0.2",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.1.1",
    "fs": "https://aistudiocdn.com/fs@^0.0.1-security",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.16.0",
    "jszip": "https://aistudiocdn.com/jszip@^3.10.1"
  }
}
</script>
</head>
  <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100">
    <div id="root"></div>
    <script defer src="./renderer.js"></script>
  </body>
</html>